# PNJL 各向异性模型 Omega 函数公式文档

## 物理背景

PNJL各向异性模型是研究强子物质在各向异性条件下相变行为的重要理论框架。该模型结合了：
- **Nambu-Jona-Lasinio (NJL)模型**：描述手征对称性破缺
- **Polyakov Loop**：描述色禁闭的有效自由度
- **各向异性参数 ξ**：描述系统在不同方向上的非均匀性

### 符号约定（全局）
- `Φ` 与 `Φ̄`：分别表示 Polyakov loop 及其共轭（文档中有时记作 Φ1, Φ2；此处统一用 Φ, Φ̄ 表示）。

## 核心 Omega 函数

### 总热力学势

总的热力学势由以下部分组成：

```
Ω_total = Ω_chiral + Ω_thermal + Ω_U
```

### 1. 手征贡献 (Ω_chiral)

```
Ω_chiral = 2G_f Σᵢ φᵢ² - 4K_f φ_u φ_d φ_s
```

其中：
- `φᵢ` (i = u,d,s) 是三种夸克味的手征凝聚
- `G_f` 是四费米子相互作用强度
- `K_f` 是六费米子相互作用强度

### 2. 热力学贡献 (Ω_thermal)

各向异性情况下的夸克部分热力学势应采用与文献式(4) 等价的分解，显式区分真空（vac）与介质/热（med 或 th）两项，并写出退化度与颜色因子以便数值实现：

```
Ω_thermal_total = Ω_vac + Ω_th
```

其中取一般形式（参考文献式(4)）：

```
Ω_vac = -g_spin * N_c * Σ_f ∫_0^{Λ_f} dp ∫_{-1}^{1} dt  (p^2/(2π^2))  E_f(p,t)

Ω_th = -T * g_spin * Σ_f ∫_0^{Λ_f} dp ∫_{-1}^{1} dt  (p^2/(2π^2))
	[ ln ℱ_f(E_f, μ_f; Φ, Φ̄) + ln ℱ_f(E_f, -μ_f; Φ̄, Φ) ]
```

说明：
- g_spin = 2（自旋简并）
- N_c = 3（颜色数）
- Σ_f 表示对夸克味求和（u,d,s）
- 积分中角变量 t = cosθ，区间为 [-1,1]；如果在实现中只使用 t ∈ [0,1]，需在结果上乘以 2
- 动量权重 p^2/(2π^2) 来自 d^3p/(2π)^3 做角积分后得到的因子（4π 被吸收进该表达）

单粒子能量的各向异性表达（与文献一致）：

```
E_f(p,t) = sqrt(m_f^2 + p^2 + ξ * (p * t)^2)
```

Polyakov 扩张的统计因子取包含到三阶指数项的完整群论形式：

```
ℱ_f(E, μ; Φ, Φ̄) = 1 + 3 Φ exp(-β(E - μ)) + 3 Φ̄ exp(-2 β(E - μ)) + exp(-3 β(E - μ))
```

热项中必须同时包含反夸克项（μ → -μ）以保证总贡献完整：

```
ln ℱ_f(E, μ) + ln ℱ_f(E, -μ)
```

真空项 Ω_vac 通常需要用 NJL 的截断或其它正规化方案处理；数值计算时可将 Ω_vac 中的积分上限设为 flavor-dependent 截断 Λ_f，并与仓库中已有的 integration/regularization 方法保持一致。

数值实现要点：
- 保持角度区间的一致性（[-1,1] 或 [0,1] + 乘 2）
- 明确使用的动量权重 p^2/(2π^2)
- 统计展开须包含到 exp(-3β(E±μ)) 并包含反粒子项
- 真空项必须正则化（与 `integration` 模块保持一致）


Polyakov-loop 变量在本文档中记为 Φ (常写作 Φ) 与 Φ̄（或 Φ1, Φ2），在此处为清晰起见令 Φ ≡ Φ1, Φ̄ ≡ Φ2。对于三色系统，单粒子统计因子的完整展开应包含到三阶指数项（群论展开），例如常见等价形式：

```
ℱ_i(p,t) = 1 + 3Φ e^{-(E_i-μ_i)/T} + 3Φ̄ e^{-2(E_i-μ_i)/T} + e^{-3(E_i-μ_i)/T}
```

对应的对数项 ln ℱ_i 同时应包括反夸克（μ_i → -μ_i）项以计算总热项：

```
ln ℱ_i(p,t) + ln ℱ̄_i(p,t)  (where ℱ̄_i uses μ_i -> -μ_i and Φ <-> Φ̄ if needed)
```

注：文档中原先使用的简写 L1 = Φ1 + Φ2, L2 = Φ1Φ2 可以用于等价的多项式重写，但要确保包含 e^{-3(...) } 项与反夸克贡献；若在代码实现中只使用到 1 + L1 e^{-x} + L2 e^{-2x} 的形式，应核对该简写是否与采用的 Polyakov 势和色配分一致。

此外，真空项 Ω_vac 通常写为（示意）：

```
Ω_vac = -2 ∑_i ∫_0^{Λf} dp  p^2/(2π^2)  E_i(p,t)  + (condensate terms)
```

并需对真空零点能做正则化/减法（与仓库中 integration 与正则化实现保持一致）。

小结：请在数值实现时确认下列约定一致：角度区间（[-1,1] 或 [0,1] + 2）、动量权重 p^2/(2π^2)、统计展开包含 e^{-3x} 与反粒子项、以及真空项的正则化方法。

### 3. Polyakov 势能贡献 (Ω_U)

```
Ω_U = T⁴[-½Tₐ Φ₁Φ₂ + T_b ln(1 - 6Φ₁Φ₂ + 4(Φ₁³ + Φ₂³) - 3(Φ₁Φ₂)²)]
```

其中：
- `Tₐ = a₀ + a₁(T₀/T) + a₂(T₀/T)²`
- `T_b = b₃(T₀/T)³`
- `T₀` 是临界温度参数

### 4. 有效质量方程

有效质量由自洽条件确定：

```
mᵢ = m₀ᵢ - 4G_f φᵢ + 2K_f φⱼφₖ  (i≠j≠k)
```

具体为：
- `m_u = m₀_q - 4G_f φ_u + 2K_f φ_d φ_s`
- `m_d = m₀_q - 4G_f φ_d + 2K_f φ_u φ_s`  
- `m_s = m₀_s - 4G_f φ_s + 2K_f φ_u φ_d`

## 数值积分实现

### 被积函数定义

根据上述公式，主要的被积函数为：

```julia
# 热力学对数项（包含粒子与反粒子）
# ℱ_q = 1 + 3Φ*exp(-β(E-μ)) + 3Φ̄*exp(-2β(E-μ)) + exp(-3β(E-μ))
# ℱ_anti = 1 + 3Φ̄*exp(-β(E+μ)) + 3Φ*exp(-2β(E+μ)) + exp(-3β(E+μ))
f_thermal(p, t, i) = begin
	E = E_i(p,t)
	F_q = 1 + 3*Φ*exp(-(E - μ[i])/T) + 3*Φ̄*exp(-2*(E - μ[i])/T) + exp(-3*(E - μ[i])/T)
	F_anti = 1 + 3*Φ̄*exp(-(E + μ[i])/T) + 3*Φ*exp(-2*(E + μ[i])/T) + exp(-3*(E + μ[i])/T)
	return log(F_q) + log(F_anti)
end

# 各向异性能量
E_i(p, t) = √(mᵢ² + p²*(ξ*t² + 1))

# 积分权重 (球坐标，角积分后)
weight = p² / (2π^2)
```

### 积分接口调用

使用统一积分接口：

```julia
# 2D积分：动量和角度
result = integrate_2d(method, p_nodes, p_weights, t_nodes, t_weights, integrand)

# 其中 integrand = f_thermal * weight
```

## 物理量计算

### 压力

```
P = -∂Ω/∂V = -Ω  (在均匀系统中)
```

### 夸克数密度

```
nᵢ = -∂Ω/∂μᵢ
```

### 手征凝聚

```
⟨q̄q⟩ᵢ = -∂Ω/∂m₀ᵢ = φᵢ
```

### 各向异性参数的作用

当 ξ ≠ 1 时：
- ξ > 1：z方向拉伸（prolate）
- ξ < 1：z方向压缩（oblate）  
- ξ = 1：各向同性情况

## 数值稳定性注意事项

1. **对数函数**：使用 `safe_log` 避免负值或零值
2. **指数函数**：注意大指数时的溢出
3. **积分收敛**：合理选择截止参数和积分精度
4. **自洽求解**：使用稳定的数值求根方法

这些公式为 `calculate_pressure_aniso()` 等函数的实现提供了物理基础。
